<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="google-site-verification" content="lwmIH0COVe7Sf23P18kkecGNqi7TehryeBCQibFoxdU" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#0b1220" />

  <title>Ramanujan Magic Square (Birthday Generator)</title>
  <meta name="description" content="Generate Ramanujan-style 4√ó4 birthday magic squares. Reverse-search birth dates from Magic Sum + Year with leap-year accurate validation. Download PNG and share links." />
  <meta name="robots" content="index,follow" />

  <link rel="canonical" href="https://alif1601.github.io/ramanujan-magic-square/" />

  <meta property="og:title" content="Ramanujan Magic Square (Birthday Generator)" />
  <meta property="og:description" content="Birth date ‚Üí Magic Square. Magic Sum + Year ‚Üí valid birth dates (leap-year accurate). Download PNG + share link." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://alif1601.github.io/ramanujan-magic-square/" />
  <meta property="og:image" content="https://alif1601.github.io/ramanujan-magic-square/assets/og-image.png" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Ramanujan Magic Square (Birthday Generator)" />
  <meta name="twitter:description" content="Generate a Ramanujan-style birthday magic square instantly. Download PNG + share link." />
  <meta name="twitter:image" content="https://alif1601.github.io/ramanujan-magic-square/assets/og-image.png" />

  <link rel="manifest" href="./site.webmanifest" />
  <link rel="icon" href="./assets/favicon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./assets/apple-touch-icon.png" />

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline';
                 object-src 'none';
                 base-uri 'self';
                 frame-ancestors 'none';" />

  <style>
    :root { --bg:#0b1220; --card:#121b2f; --muted:#9aa7c2; --text:#e8eeff; --accent:#6ee7ff; --good:#7CFF9A; --bad:#ff7c7c; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #12224a 0%, transparent 55%),
                  radial-gradient(1000px 500px at 80% 20%, #1b2c5a 0%, transparent 50%),
                  var(--bg);
      color: var(--text);
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 22px; }
    header { display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1 { margin: 0; font-size: 20px; letter-spacing: .2px; }
    .sub { margin-top: 6px; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .grid { margin-top: 18px; display:grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 10px; font-size: 15px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input, button {
      width: 100%;
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
    }
    input:focus { border-color: rgba(110,231,255,.55); box-shadow: 0 0 0 3px rgba(110,231,255,.16); }
    button {
      cursor:pointer;
      background: linear-gradient(180deg, rgba(110,231,255,.20), rgba(110,231,255,.10));
      border-color: rgba(110,231,255,.35);
      transition: transform .05s ease;
      font-weight: 700;
    }
    button:active { transform: translateY(1px); }
    .row { display:grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 520px) { .row { grid-template-columns: 1fr 1fr; } }
    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; }
    .msg { margin-top: 10px; font-size: 13px; }
    .msg.good { color: var(--good); }
    .msg.bad { color: var(--bad); }

    .sq-wrap { margin-top: 10px; display:flex; gap: 14px; flex-wrap:wrap; align-items:flex-start; }
    table.square {
      border-collapse: separate;
      border-spacing: 8px;
      background: rgba(0,0,0,.18);
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      min-width: 260px;
    }
    table.square td {
      text-align:center;
      padding: 10px 8px;
      min-width: 54px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      font-variant-numeric: tabular-nums;
      font-weight: 750;
    }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-size: 12px; color: var(--muted);
      margin-top: 8px;
    }
    .pill b { color: var(--text); }
    .accent { color: var(--accent); }
    .results {
      margin-top: 10px;
      max-height: 260px;
      overflow:auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .results button.item {
      width: 100%;
      text-align:left;
      border: 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
      border-radius: 0;
      background: transparent;
      padding: 10px 12px;
      font-weight: 650;
    }
    .results button.item:hover { background: rgba(255,255,255,.05); }
    .results button.item:last-child { border-bottom: 0; }
    footer { margin-top: 18px; color: var(--muted); font-size: 12px; }
    code.kbd { padding: 2px 6px; border-radius: 8px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Ramanujan Magic Square (Birthday Generator)",
    "applicationCategory": "EducationalApplication",
    "operatingSystem": "Any",
    "description": "Generate Ramanujan-style 4√ó4 birthday magic squares and reverse-search dates from Magic Sum + Year."
  }
  </script>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üé© Ramanujan Magic Square (Birthday)</h1>
        <div class="sub">
          Works both ways: <span class="accent">Birth date ‚Üí Magic Square</span> and
          <span class="accent">Magic Sum + Year ‚Üí valid birth dates</span> (with leap-year validation).
          <div class="hint">New: <span class="accent">Download PNG</span> + <span class="accent">Share link</span> (prefilled date).</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="card" aria-label="Birth date to Magic Square">
        <h2>1) Birth date ‚Üí Magic Square</h2>

        <label for="dob">Birth date</label>
        <input id="dob" type="date" />

        <div class="hint">Tip: date picker outputs valid YYYY-MM-DD.</div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnGen" type="button" style="flex:1; min-width:180px;">Generate Square</button>
          <button id="btnVerify1" type="button" style="flex:1; min-width:180px; opacity:.95;">Verify Magic</button>
          <button id="btnPng1" type="button" style="flex:1; min-width:180px; opacity:.95;">Download PNG</button>
          <button id="btnShare1" type="button" style="flex:1; min-width:180px; opacity:.95;">Copy Share Link</button>
          <button id="btnClear1" type="button" style="flex:1; min-width:140px; opacity:.9;">Clear</button>
        </div>

        <div id="msg1" class="msg" role="status" aria-live="polite"></div>

        <div id="out1" class="sq-wrap" style="display:none;">
          <div>
            <table class="square" id="sq1" aria-label="Generated magic square"></table>
            <div class="pill">Magic Sum: <b id="sum1"></b></div>
            <div class="pill">Top row: <b id="toprow1"></b></div>
            <div class="pill">Verify: <b id="verify1"></b></div>
          </div>
          <div style="flex:1; min-width: 220px;">
            <div class="pill">Formula: <b>S = d + m + (y/100) + (y%100)</b></div>
            <div class="hint" style="margin-top:10px;">
              This generates a true 4√ó4 magic square (all rows/cols/diagonals sum to S).
            </div>
            <div class="hint" style="margin-top:6px;">
              Share link example: <code class="kbd">?d=4&m=9&y=1998</code>
            </div>
          </div>
        </div>
      </section>

      <section class="card" aria-label="Reverse search from Magic Sum and Year">
        <h2>2) Magic Sum + Year ‚Üí Birth dates</h2>

        <div class="row">
          <div>
            <label for="sumIn">Magic Sum</label>
            <input id="sumIn" type="number" inputmode="numeric" placeholder="e.g., 130" />
          </div>
          <div>
            <label for="yearIn">Year (YYYY)</label>
            <input id="yearIn" type="number" inputmode="numeric" placeholder="e.g., 1998" />
          </div>
        </div>

        <label for="autoSquare" style="display:flex; gap:10px; align-items:center; margin-top:12px;">
          <input id="autoSquare" type="checkbox" style="width:auto; transform: scale(1.05);" checked />
          Auto-generate square when I click a matching date
        </label>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnFind" type="button" style="flex:1; min-width:180px;">Find Dates</button>
          <button id="btnClear2" type="button" style="flex:1; min-width:140px; opacity:.9;">Clear</button>
        </div>

        <div id="msg2" class="msg" role="status" aria-live="polite"></div>

        <div id="resultBox" style="display:none;">
          <div class="pill">Matches found: <b id="count2"></b></div>
          <div class="results" id="results" aria-label="Matching dates list"></div>

          <div id="picked" style="display:none; margin-top:12px;">
            <div class="pill">Selected date: <b id="pickedDate"></b></div>
            <div class="sq-wrap">
              <table class="square" id="sq2" aria-label="Magic square for selected date"></table>
              <div>
                <div class="pill">Magic Sum: <b id="sum2"></b></div>
                <div class="pill">Top row: <b id="toprow2"></b></div>
                <div class="pill">Verify: <b id="verify2"></b></div>

                <button id="btnVerify2" type="button" style="margin-top:10px;">Verify Magic</button>
                <button id="btnPng2" type="button" style="margin-top:10px;">Download PNG</button>
                <button id="btnShare2" type="button" style="margin-top:10px;">Copy Share Link</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <footer>
      Quick test: <code class="kbd">04-09-1998</code> ‚áí sum <code class="kbd">130</code>.
      <span style="margin-left:10px;">‚Ä¢</span>
      <a href="./sitemap.xml">sitemap</a>
    </footer>
  </div>

<script>
  // --- PWA service worker ---
  (function registerSW(){
    if (!("serviceWorker" in navigator)) return;
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  })();

  function isLeapYear(y) {
    if (y % 400 === 0) return true;
    if (y % 100 === 0) return false;
    return (y % 4 === 0);
  }
  function daysInMonth(m, y) {
    switch (m) {
      case 1: return 31;
      case 2: return isLeapYear(y) ? 29 : 28;
      case 3: return 31;
      case 4: return 30;
      case 5: return 31;
      case 6: return 30;
      case 7: return 31;
      case 8: return 31;
      case 9: return 30;
      case 10: return 31;
      case 11: return 30;
      case 12: return 31;
      default: return 0;
    }
  }
  function pad2(n) { return String(n).padStart(2, "0"); }

  function parseDateInput(iso) {
    if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return null;
    const [Y, M, D] = iso.split("-").map(Number);
    const maxD = daysInMonth(M, Y);
    if (M < 1 || M > 12) return null;
    if (D < 1 || D > maxD) return null;
    return { d: D, m: M, y: Y };
  }

  // ‚úÖ Real Ramanujan-style 4√ó4 magic square:
  // Uses (d, m, a, b) and produces a true magic square sum S = d+m+a+b.
  function buildMagicSquare(d, m, y) {
    const a = Math.floor(y / 100);
    const b = y % 100;
    const S = d + m + a + b;

    const sq = [
      [d,     m,     a,     b],
      [b + 1, a - 1, m - 3, d + 3],
      [m - 2, d + 2, b + 2, a - 2],
      [a + 1, b - 1, d + 1, m - 1],
    ];

    return { sq, S, topRow: `${d} + ${m} + ${a} + ${b} = ${S}` };
  }

  function renderSquare(tableEl, sq) {
    tableEl.innerHTML = "";
    const tbody = document.createElement("tbody");
    for (let i = 0; i < 4; i++) {
      const tr = document.createElement("tr");
      for (let j = 0; j < 4; j++) {
        const td = document.createElement("td");
        td.textContent = sq[i][j];
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    tableEl.appendChild(tbody);
  }

  function setMsg(el, text, kind) {
    el.textContent = text || "";
    el.className = "msg " + (kind || "");
  }

  function verifyMagicSquare(sq, expectedSum) {
    if (!sq || sq.length !== 4) return { ok: false, detail: "Invalid square" };

    const sums = [];
    // rows
    for (let r = 0; r < 4; r++) sums.push(sq[r].reduce((a, v) => a + v, 0));
    // cols
    for (let c = 0; c < 4; c++) {
      let s = 0;
      for (let r = 0; r < 4; r++) s += sq[r][c];
      sums.push(s);
    }
    // diagonals
    let d1 = 0, d2 = 0;
    for (let i = 0; i < 4; i++) {
      d1 += sq[i][i];
      d2 += sq[i][3 - i];
    }
    sums.push(d1, d2);

    const ok = sums.every(v => v === expectedSum);
    if (ok) return { ok: true, detail: `‚úÖ All rows/cols/diagonals = ${expectedSum}` };

    const bad = sums.filter(v => v !== expectedSum);
    return { ok: false, detail: `‚ùå Not magic. Expected ${expectedSum}, mismatches: ${bad.join(", ")}` };
  }

  // -------- Share link helpers --------
  function getBaseUrl() {
    // Works on GitHub Pages project sites
    return window.location.origin + window.location.pathname.replace(/\/index\.html$/, "");
  }
  function buildShareUrl(d, m, y) {
    const base = getBaseUrl().replace(/\/$/, "");
    const qs = new URLSearchParams({ d: String(d), m: String(m), y: String(y) });
    return `${base}/?${qs.toString()}`;
  }
  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }
  }

  // -------- PNG helpers --------
  function roundRect(ctx, x, y, w, h, r, fill, stroke) {
    const radius = typeof r === "number" ? { tl: r, tr: r, br: r, bl: r } : r;
    ctx.beginPath();
    ctx.moveTo(x + radius.tl, y);
    ctx.lineTo(x + w - radius.tr, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + radius.tr);
    ctx.lineTo(x + w, y + h - radius.br);
    ctx.quadraticCurveTo(x + w, y + h, x + w - radius.br, y + h);
    ctx.lineTo(x + radius.bl, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - radius.bl);
    ctx.lineTo(x, y + radius.tl);
    ctx.quadraticCurveTo(x, y, x + radius.tl, y);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function drawSquareToCanvas(ctx, sq, S, title) {
    const W = ctx.canvas.width;
    const H = ctx.canvas.height;

    // background
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(0, 0, W, H);

    // title
    ctx.fillStyle = "#e8eeff";
    ctx.font = "700 44px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(title, 60, 90);

    // subtitle
    ctx.fillStyle = "#9aa7c2";
    ctx.font = "500 28px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(`Magic Sum: ${S}`, 60, 135);

    // grid area
    const gridSize = 520;
    const x0 = 60;
    const y0 = 180;
    const cell = gridSize / 4;

    // card
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    roundRect(ctx, x0 - 18, y0 - 18, gridSize + 36, gridSize + 36, 24, true, false);

    // cells
    ctx.font = "700 44px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    for (let r = 0; r < 4; r++) {
      for (let c = 0; c < 4; c++) {
        const x = x0 + c * cell;
        const y = y0 + r * cell;

        ctx.fillStyle = "rgba(255,255,255,0.08)";
        roundRect(ctx, x + 10, y + 10, cell - 20, cell - 20, 18, true, false);

        ctx.fillStyle = "#e8eeff";
        ctx.fillText(String(sq[r][c]), x + cell / 2, y + cell / 2);
      }
    }

    // footer
    ctx.textAlign = "left";
    ctx.fillStyle = "#6ee7ff";
    ctx.font = "600 24px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("Ramanujan Magic Square", 60, H - 60);

    ctx.fillStyle = "#9aa7c2";
    ctx.font = "500 20px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(getBaseUrl(), 60, H - 30);
  }

  function downloadSquarePNG(sq, S, label) {
    const canvas = document.createElement("canvas");
    canvas.width = 1200;
    canvas.height = 800;

    const ctx = canvas.getContext("2d");
    drawSquareToCanvas(ctx, sq, S, `Birthday: ${label}`);

    const a = document.createElement("a");
    a.download = `ramanujan-magic-square-${label}.png`;
    a.href = canvas.toDataURL("image/png");
    a.click();
  }

  // ------- DOM -------
  const dob = document.getElementById("dob");
  const btnGen = document.getElementById("btnGen");
  const btnVerify1 = document.getElementById("btnVerify1");
  const btnPng1 = document.getElementById("btnPng1");
  const btnShare1 = document.getElementById("btnShare1");
  const btnClear1 = document.getElementById("btnClear1");
  const msg1 = document.getElementById("msg1");
  const out1 = document.getElementById("out1");
  const sq1 = document.getElementById("sq1");
  const sum1 = document.getElementById("sum1");
  const toprow1 = document.getElementById("toprow1");
  const verify1 = document.getElementById("verify1");

  const sumIn = document.getElementById("sumIn");
  const yearIn = document.getElementById("yearIn");
  const autoSquare = document.getElementById("autoSquare");
  const btnFind = document.getElementById("btnFind");
  const btnClear2 = document.getElementById("btnClear2");
  const msg2 = document.getElementById("msg2");
  const resultBox = document.getElementById("resultBox");
  const results = document.getElementById("results");
  const count2 = document.getElementById("count2");
  const picked = document.getElementById("picked");
  const pickedDate = document.getElementById("pickedDate");
  const sq2 = document.getElementById("sq2");
  const sum2 = document.getElementById("sum2");
  const toprow2 = document.getElementById("toprow2");
  const verify2 = document.getElementById("verify2");
  const btnVerify2 = document.getElementById("btnVerify2");
  const btnPng2 = document.getElementById("btnPng2");
  const btnShare2 = document.getElementById("btnShare2");

  let lastSq1 = null;
  let lastS1 = null;

  // ------- Section 1 actions -------
  btnGen.addEventListener("click", () => {
    const p = parseDateInput(dob.value);
    if (!p) {
      out1.style.display = "none";
      setMsg(msg1, "Please pick a valid date.", "bad");
      return;
    }

    const { sq, S, topRow } = buildMagicSquare(p.d, p.m, p.y);
    lastSq1 = sq;
    lastS1 = S;

    renderSquare(sq1, sq);
    sum1.textContent = S;
    toprow1.textContent = topRow;

    const v = verifyMagicSquare(sq, S);
    verify1.textContent = v.detail;

    out1.style.display = "flex";
    setMsg(msg1, `Done! Generated square for ${pad2(p.d)}-${pad2(p.m)}-${p.y}.`, "good");

    // convenience
    sumIn.value = S;
    yearIn.value = p.y;
  });

  btnVerify1.addEventListener("click", () => {
    if (!lastSq1 || !Number.isFinite(lastS1)) {
      setMsg(msg1, "Generate a square first, then verify.", "bad");
      return;
    }
    const v = verifyMagicSquare(lastSq1, lastS1);
    verify1.textContent = v.detail;
    setMsg(msg1, v.ok ? "Magic square verified ‚úÖ" : "Verification failed ‚ùå", v.ok ? "good" : "bad");
  });

  btnPng1.addEventListener("click", () => {
    const p = parseDateInput(dob.value);
    if (!p) { setMsg(msg1, "Pick a valid date first.", "bad"); return; }
    const { sq, S } = buildMagicSquare(p.d, p.m, p.y);
    const label = `${pad2(p.d)}-${pad2(p.m)}-${p.y}`;
    downloadSquarePNG(sq, S, label);
    setMsg(msg1, "PNG downloaded ‚úÖ", "good");
  });

  btnShare1.addEventListener("click", async () => {
    const p = parseDateInput(dob.value);
    if (!p) { setMsg(msg1, "Pick a valid date first.", "bad"); return; }
    const url = buildShareUrl(p.d, p.m, p.y);
    const ok = await copyToClipboard(url);
    setMsg(msg1, ok ? "Share link copied ‚úÖ" : "Copy failed ‚ùå", ok ? "good" : "bad");
  });

  btnClear1.addEventListener("click", () => {
    dob.value = "";
    out1.style.display = "none";
    setMsg(msg1, "", "");
    lastSq1 = null;
    lastS1 = null;
  });

  // ------- Reverse search -------
  function findDates(S, y) {
    const a = Math.floor(y / 100);
    const b = y % 100;
    const matches = [];
    for (let m = 1; m <= 12; m++) {
      const maxD = daysInMonth(m, y);
      for (let d = 1; d <= maxD; d++) {
        if (d + m + a + b === S) matches.push({ d, m, y });
      }
    }
    return matches;
  }

  function showPicked(dmy) {
    const label = `${pad2(dmy.d)}-${pad2(dmy.m)}-${dmy.y}`;
    pickedDate.textContent = label;

    const { sq, S, topRow } = buildMagicSquare(dmy.d, dmy.m, dmy.y);
    renderSquare(sq2, sq);
    sum2.textContent = S;
    toprow2.textContent = topRow;

    const v = verifyMagicSquare(sq, S);
    verify2.textContent = v.detail;

    picked.style.display = "block";
  }

  btnFind.addEventListener("click", () => {
    const S = Number(sumIn.value);
    const y = Number(yearIn.value);

    if (!Number.isFinite(S) || sumIn.value.trim() === "") {
      setMsg(msg2, "Please enter a valid Magic Sum (number).", "bad");
      resultBox.style.display = "none";
      return;
    }
    if (!Number.isInteger(y) || y <= 0 || yearIn.value.trim() === "") {
      setMsg(msg2, "Please enter a valid Year (positive integer).", "bad");
      resultBox.style.display = "none";
      return;
    }

    const matches = findDates(S, y);
    results.innerHTML = "";
    picked.style.display = "none";
    resultBox.style.display = "block";
    count2.textContent = matches.length;

    if (matches.length === 0) {
      setMsg(msg2, `No valid birth date found for Magic Sum ${S} in year ${y}.`, "bad");
      return;
    }

    setMsg(msg2, `Found ${matches.length} valid date(s). Click one to view its magic square.`, "good");

    for (const dmy of matches) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "item";
      btn.textContent = `${pad2(dmy.d)}-${pad2(dmy.m)}-${dmy.y}`;
      btn.addEventListener("click", () => {
        if (autoSquare.checked) showPicked(dmy);
        else {
          picked.style.display = "none";
          setMsg(msg2, `Selected ${btn.textContent}. (Enable auto-generate to show square)`, "good");
        }
      });
      results.appendChild(btn);
    }

    if (autoSquare.checked) showPicked(matches[0]);
  });

  btnVerify2.addEventListener("click", () => {
    const expected = Number(sum2.textContent);
    if (!Number.isFinite(expected)) { setMsg(msg2, "Select a date first.", "bad"); return; }

    const cells = [...sq2.querySelectorAll("td")].map(td => Number(td.textContent));
    if (cells.length !== 16 || cells.some(n => !Number.isFinite(n))) {
      setMsg(msg2, "No square found to verify.", "bad");
      return;
    }
    const sq = [cells.slice(0,4), cells.slice(4,8), cells.slice(8,12), cells.slice(12,16)];
    const v = verifyMagicSquare(sq, expected);
    verify2.textContent = v.detail;
    setMsg(msg2, v.ok ? "Magic square verified ‚úÖ" : "Verification failed ‚ùå", v.ok ? "good" : "bad");
  });

  btnPng2.addEventListener("click", () => {
    const label = pickedDate.textContent?.trim();
    const expected = Number(sum2.textContent);
    const cells = [...sq2.querySelectorAll("td")].map(td => Number(td.textContent));

    if (!label || !Number.isFinite(expected) || cells.length !== 16) {
      setMsg(msg2, "Select a date first.", "bad");
      return;
    }
    const sq = [cells.slice(0,4), cells.slice(4,8), cells.slice(8,12), cells.slice(12,16)];
    downloadSquarePNG(sq, expected, label);
    setMsg(msg2, "PNG downloaded ‚úÖ", "good");
  });

  btnShare2.addEventListener("click", async () => {
    const label = pickedDate.textContent?.trim(); // "DD-MM-YYYY"
    if (!label) { setMsg(msg2, "Select a date first.", "bad"); return; }
    const [dd, mm, yy] = label.split("-").map(Number);
    const url = buildShareUrl(dd, mm, yy);
    const ok = await copyToClipboard(url);
    setMsg(msg2, ok ? "Share link copied ‚úÖ" : "Copy failed ‚ùå", ok ? "good" : "bad");
  });

  btnClear2.addEventListener("click", () => {
    sumIn.value = "";
    yearIn.value = "";
    results.innerHTML = "";
    picked.style.display = "none";
    resultBox.style.display = "none";
    setMsg(msg2, "", "");
  });

  // -------- Hydrate from share link query: ?d=4&m=9&y=1998 --------
  (function hydrateFromQuery() {
    const q = new URLSearchParams(window.location.search);
    const d = Number(q.get("d"));
    const m = Number(q.get("m"));
    const y = Number(q.get("y"));
    if (!Number.isInteger(d) || !Number.isInteger(m) || !Number.isInteger(y)) return;

    const maxD = daysInMonth(m, y);
    if (m < 1 || m > 12 || d < 1 || d > maxD) return;

    // set date input (YYYY-MM-DD)
    dob.value = `${String(y).padStart(4,"0")}-${pad2(m)}-${pad2(d)}`;

    // auto-generate
    btnGen.click();
  })();
</script>
</body>
</html>